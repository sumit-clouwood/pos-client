<template>
  <Preloader v-if="dataBeingLoaded" />
  <div
    v-else
    :class="['invoice-body', template.rtl_supported ? 'rtl' : 'ltr']"
    :style="{ direction: template.rtl_supported ? 'rtl' : 'ltr' }"
  >
    <div class="header">
      <div
        style="
          text-align: center;
          font-weight: 700;
          padding: 0 0 0.3em 0;
          font-size: 3em;"
        v-if="
          allowed(PERMS.TOKEN_NUMBER) &&
            isTokenManager &&
            tokenNumber &&
            (orderType.OTApi === 'walk_in' || orderType.OTApi === 'carhop')
        "
      >
        {{ tokenNumber }}
      </div>

      <template v-if="template.show_logo">
        <img class="header-img" :src="company_logo" alt="Logo" />
      </template>
      <span v-if="template.use_default_header" v-html="default_header"> </span>
      <span v-else v-html="template.header"> </span>
    </div>
    <div class="main">
      <div class="main-title">{{ template.title_label }}</div>
      <div class="main-subtitle" v-if="!preview">
        {{ template.invoice_number_label }}
        {{ getPrintDataTime }}
      </div>
      <table class="print-invoice-table">
        <thead>
          <tr
            v-if="
              template.show_delivery_address &&
                customer &&
                order.order_delivery_area
            "
            class="full-width small-padding"
          >
            <td colspan="3">
              <div>
                {{ template.deliver_to_label }}
              </div>
              <div>
                <strong>{{ customer.name }}</strong>
              </div>
              <div>
                <strong>{{ customer.phone }}</strong>
              </div>
              <br />
              <div>
                {{ order.order_flat_number }} {{ order.order_building }}
              </div>
              <div>
                {{ order.order_street }} {{ order.order_nearest_landmark }}
              </div>
              <div>{{ get_delivery_area_name(order.order_delivery_area) }}</div>
            </td>
          </tr>
          <tr class="left-aligned">
            <th colspan="3">
              {{ template.order_type_label }}
              <span class="float-right">{{ order_type }}</span>
            </th>
          </tr>
          <tr
            class="left-aligned"
            v-if="selectedTableRservationData && orderType.OTApi === 'dine_in'"
          >
            <th colspan="3">
              {{ template.table_number_label }}
              <span class="float-right">
                {{ selectedTableRservationData }}
              </span>
            </th>
          </tr>
          <tr v-if="crm_module_enabled && customer" class="left-aligned">
            <th colspan="3">
              {{ template.customer_label }}
              <span class="float-right">{{ customer.name }}</span>
            </th>
          </tr>
          <tr class="left-aligned">
            <th colspan="3">
              {{ template.staff_label }}
              <span class="float-right">{{ placed_by }}</span>
            </th>
          </tr>
          <tr class="left-aligned last-thead">
            <th colspan="3">
              {{ created_date }}
              <span class="float-right">{{ created_time }}</span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr class="table-title">
            <th class="first-col">{{ template.qty_label }}</th>
            <th>{{ template.item_label }}</th>
            <th class="right-aligned">{{ template.amount_label }}</th>
          </tr>
          <template v-for="(item, key) in order.items">
            <tr :key="'item' + key">
              <td class="first-col" valign="top">
                {{ item.qty }} {{ measurement_unit(item) }}
              </td>
              <td>
                <div class="food-title">
                  {{ translate_item(item) }}
                  <span
                    >({{
                      format_number(
                        parseFloat(item.price) + parseFloat(item.tax)
                      )
                    }})&#x200E;</span
                  >
                </div>
                <template v-for="(modifier, i) in order.item_modifiers">
                  <template v-if="modifier.for_item == item.no">
                    <div class="food-extra" :key="'modifier' + i">
                      {{ translate_item_modifier(modifier, item) }}
                      <span v-if="modifier.price !== 0"
                        >({{
                          format_number(
                            parseFloat(modifier.price) +
                              parseFloat(modifier.tax)
                          )
                        }}
                        x {{ modifier.qty }})&#x200E;</span
                      >
                      <span v-else-if="modifier.qty > 1"
                        >(x {{ modifier.qty }})&#x200E;</span
                      >
                    </div>
                  </template>
                </template>
              </td>
              <td class="right-aligned" valign="top">
                {{ format_number(item_total(item.no)) }}
              </td>
            </tr>
            <tr
              v-for="(discount, key) in order.item_discounts"
              :key="'itemdiscount' + item.no + key"
              class="item-discount table-page-child"
            >
              <template v-if="discount.for_item == item.no">
                <td class="first-col table-page-child"></td>
                <td class="table-page-child">
                  <div class="food-extra">
                    {{ template.item_discount_label }}
                    <span>{{ translate_item_discount(discount) }}</span>
                  </div>
                </td>
                <td class="right-aligned table-page-child" valign="top">
                  -{{ format_number(discount_total(discount)) }}
                </td>
              </template>
            </tr>
            <tr :key="'note' + key" v-if="item.note">
              <td class="first-col table-page-child"></td>
              <td class="table-page-child">
                <span class="food-title">{{ _t('Note') }}: </span>
                <i>{{ item.note }}</i>
              </td>
              <td class="right-aligned table-page-child"></td>
            </tr>
          </template>
        </tbody>
        <tfoot>
          <tr
            v-if="template.show_order_notes && order.order_note"
            class="full-width padding-top"
          >
            <td colspan="3">
              {{ template.order_notes_label }}<br />{{ order.order_note }}
            </td>
          </tr>
          <template v-if="template.show_breakdown">
            <tr class="padding-top">
              <td colspan="2">
                {{ template.sub_total_label }}
              </td>
              <td class="right-aligned">
                {{ format_number(order.sub_total) }}
              </td>
            </tr>
            <tr
              v-for="(surcharge, key) in order.order_surcharges"
              :key="'surcharge' + key"
            >
              <td colspan="2">
                {{ translate_surcharge(surcharge) }}
              </td>
              <td class="right-aligned">
                {{ format_number(surcharge.price) }}
              </td>
            </tr>
            <tr
              v-for="(order_discount, key) in order.order_discounts"
              :key="'orderdiscount' + key"
            >
              <td colspan="2">
                {{ translate_order_discount(order_discount) }}
              </td>
              <td class="right-aligned">
                -{{ format_number(order_discount.price) }}
              </td>
            </tr>
            <tr>
              <td colspan="2">
                {{ template.tax_label }}
              </td>
              <td class="right-aligned">
                {{ format_number(order.total_tax) }}
              </td>
            </tr>
            <tr>
              <td colspan="2">
                {{ template.surcharge_tax_label }}
              </td>
              <td class="right-aligned">
                {{ format_number(order.surcharge_tax) }}
              </td>
            </tr>
            <tr v-if="parseFloat(order.delivery_surcharge) > 0">
              <td colspan="2">
                {{ _t('Delivery Surcharge') }}
              </td>
              <td class="right-aligned">
                {{ format_number(order.delivery_surcharge) }}
              </td>
            </tr>
            <tr class="important">
              <td colspan="3" class="footTotal">
                {{ template.total_label }}
                <span class="float-right">
                  {{ order.currency }} {{ format_number(order.balance_due) }}
                </span>
              </td>
            </tr>
            <tr
              v-for="(order_payment, key) in order.order_payments"
              :key="'payment' + key"
              class="footer-cash"
            >
              <td colspan="2">
                {{ translate_payment_type(order_payment) }}
                <span v-if="order_payment.param3"
                  >({{ template.card_label }} {{ order_payment.param3 }})</span
                >
              </td>
              <td class="right-aligned">
                {{ format_number(order_payment.collected) }}
              </td>
            </tr>
            <tr
              class="important"
              v-if="
                !preview && order.order_type !== CONST.ORDER_TYPE_CALL_CENTER
              "
            >
              <td colspan="3" class="footTotal">
                <div>
                  {{ template.total_paid_label }}
                  <span class="float-right"
                    >{{ order.currency }}
                    {{ format_number(order.total_paid) }}</span
                  >
                </div>
              </td>
            </tr>
            <tr
              class="important"
              v-if="order.order_type === CONST.ORDER_TYPE_CALL_CENTER"
            >
              <td colspan="3" class="footTotal">
                {{ referral_data(order.referral) }}
                {{
                  referral.referral_type === CONST.REFERRAL_TYPE_COD
                    ? 'Cash on Delivery'
                    : 'Paid by ' + referral.name
                }}
                <!--Paid by {{ getReferral(order.referral).name }} {{ referral }}-->
              </td>
            </tr>
            <tr
              v-if="
                !preview && order.order_type !== CONST.ORDER_TYPE_CALL_CENTER
              "
            >
              <td colspan="2">
                {{ template.tips_label }}
              </td>
              <td class="right-aligned">
                {{ format_number(order.tip_amount) }}
              </td>
            </tr>
            <tr
              v-if="
                !preview && order.order_type !== CONST.ORDER_TYPE_CALL_CENTER
              "
            >
              <td colspan="2">
                {{ template.changed_label }}
              </td>
              <td class="right-aligned">
                {{ format_number(order.amount_changed) }}
              </td>
            </tr>
            <tr
              v-for="(cards_with_point, key) in order.loyalty_cards_with_points"
              :key="'loyalty' + key"
            >
              <td colspan="2">
                {{ template.loyalty_points_earned_label }}
              </td>
              <td class="right-aligned">
                {{ format_number(cards_with_point.points) }}
              </td>
            </tr>
          </template>
        </tfoot>
      </table>
    </div>
    <div class="footer" v-html="template.footer"></div>
  </div>
</template>

<script>
import Preloader from '@/components/util/Preloader'
import { mapGetters, mapState } from 'vuex'
var moment = require('moment')
import DateTime from '@/mixins/DateTime'

export default {
  name: 'PrintTemplate',
  components: {
    Preloader,
  },
  mixins: [DateTime],
  data() {
    return {
      currentBrand: this.$store.state.location.brand,
      referral: false,
      currentStore: this.$store.state.location.store,
      current_locale: this.$store.state.location.locale,
      company_logo:
        this.$store.state.location.brand &&
        this.$store.state.location.brand.company_logo
          ? this.$store.state.location.brand.company_logo
          : '',
    }
  },
  mounted() {
    this.toDataURL(
      this.company_logo,
      base64 => {
        this.company_logo = base64
      },
      'image/png'
    )
  },
  props: ['template', 'order_to_print', 'preview'],
  watch: {
    all_data_fully_loaded: function(new_value) {
      // eslint-disable-next-line
      if (new_value == true) {
        this.$nextTick(() => this.$emit('print_ready'))
      }
    },
  },
  computed: {
    ...mapState('checkout', ['print']),
    ...mapGetters('location', ['_t', 'isTokenManager', 'getReferral']),
    ...mapState('location', ['timezoneString']),
    ...mapGetters('auth', ['allowed']),
    ...mapState('dinein', ['selectedTableRservationData']),
    ...mapState('order', ['orderType']),

    dataBeingLoaded() {
      if (!this.order_to_print || !this.template) {
        return true
      }
      return false
    },
    getPrintDataTime() {
      let order = this.order
      let orderNo = order.order_no
        ? order.order_no
        : order.orderNumber
        ? order.orderNumber
        : false
      let dateTime = order.real_created_datetime
        .toString()
        .replace(/[\s-:]/g, '')
      if (orderNo) {
        return orderNo
      } else {
        return dateTime
      }
    },
    crm_module_enabled: function() {
      let cb =
        typeof this.currentBrand == 'undefined'
          ? this.$store.state.location.brand
          : this.currentBrand
      for (var module of cb.enabled_modules) {
        //TODO - make constant
        if (module == 'CRM') {
          return true
        }
      }
      return false
    },
    active_store: function() {
      return this.currentStore
    },
    default_header: function() {
      if (this.active_store) {
        return `${this.currentBrand.name} <br/> ${this.active_store.city} ${this.template['branch_label']} <br/> ${this.template['telno_label']} ${this.active_store.phone}`
      } else {
        return ''
      }
    },

    current_time: function() {
      moment.locale(this.current_locale)
      return moment().local()
    },
    created_time() {
      if (this.order_to_print) {
        return this.convertDatetime(
          this.order.real_created_datetime,
          this.timezoneString,
          'h:mm:ss A'
        )
      }
      return this.current_time.format('h:mm A')
    },
    created_date() {
      if (this.order_to_print) {
        return this.convertDatetime(
          this.order.real_created_datetime,
          this.timezoneString,
          'Do MMMM YYYY'
        )
      }
      return this.current_time.format('Do MMMM YYYY')
    },
    placed_by: function() {
      return this.$store.state.location.userShortDetails.username
        ? this.$store.state.location.userShortDetails.username
        : this.$store.state.auth.userDetails.item.name
    },
    tokenNumber() {
      if (
        this.isTokenManager &&
        this.allowed(this.PERMS.TOKEN_NUMBER) &&
        (this.orderType.OTApi === 'walk_in' ||
          this.orderType.OTApi === 'carhop')
      ) {
        if (
          this.$store.state.sync.online &&
          typeof this.order.tokenNumber != 'undefined'
        ) {
          return this.order.tokenNumber
        } else if (typeof this.order.token_number != 'undefined') {
          return this.order.token_number
        }
      }

      return false
    },
    //If the customer is set in the order, we check if there is a property with customer info. If there is -
    // we output it. If there are no, we use sample customer. If customer is not set on the order -
    // that means there should be no customer in that order
    customer() {
      if (this.order) {
        if (this.$store.state.customer.offlineData) {
          return {
            name: this.$store.state.customer.offlineData.name,
            phone: this.$store.state.customer.offlineData.phone_number,
          }
        }
        if (this.order.customer) {
          return {
            name: this.$store.state.customer.customer.name,
            phone: this.$store.state.customer.customer.phone_number,
          }
        }
      }
      return null
    },
    order_type() {
      return this.template[this.order.order_type + '_label']
    },
    all_data_fully_loaded() {
      //these are needed at main app to trigger loads for collections in question
      if (this.order_to_print && this.template && this.print) {
        return true
      }
      return false
    },
    //This is a method to generate fake order for invoice generation. No need to have bottom part of it at the POS
    order() {
      if (this.dataBeingLoaded) {
        return null
      }
      return this.order_to_print
    },
  },
  methods: {
    referral_data(referralId) {
      this.referral = this.$store.getters['location/getReferral'](referralId)
    },
    is_ready_to_print() {
      if (this.all_data_fully_loaded) {
        return true
      }
      return false
    },
    format_number(number) {
      return parseFloat(number).toFixed(2)
    },
    translate_entity(entity, attribute) {
      var results = []
      for (var lng of this.template.languages) {
        if (
          entity['translations_dict'] &&
          entity['translations_dict'][attribute] &&
          entity['translations_dict'][attribute][lng]
        ) {
          results.push(entity['translations_dict'][attribute][lng])
        } else {
          results.push(entity[attribute])
        }
      }
      return results.join(' / ')
    },
    measurement_unit(item) {
      if (item.measurement_unit) {
        return item.measurement_unit
      }
      return ''
    },
    discount_total(discount) {
      if (discount.type === 'fixed_price') {
        return parseFloat(discount.price) + parseFloat(discount.tax)
      } else {
        return parseFloat(discount.price)
      }
    },
    item_total(item_no) {
      var total = 0
      for (var item of this.order.items) {
        if (item.no == item_no) {
          total += (parseFloat(item.price) + parseFloat(item.tax)) * item.qty
        }
      }
      for (var modifier of this.order.item_modifiers) {
        if (modifier.for_item == item_no) {
          total +=
            (parseFloat(modifier.price) + parseFloat(modifier.tax)) *
            modifier.qty
        }
      }
      for (var item_discount of this.order.item_discounts) {
        if (item_discount.for_item == item_no) {
          total -= parseFloat(item_discount.price)
          total -= parseFloat(item_discount.tax)
        }
      }
      return total < 0 ? '0.00' : total
    },
    //These methods would need to be updated at POS to search for objects in POS store
    //These functions
    translate_item(orderItem) {
      var found_item = this.$store.getters['category/items'].find(
        item => item._id == orderItem.entity_id
      )
      if (found_item) {
        if (found_item.name === 'Open Item') {
          return this.translate_entity(orderItem, 'name')
        }
        return this.translate_entity(found_item, 'name')
      } else {
        return orderItem.name
      }
    },
    translate_item_modifier(item, orderItem) {
      var found_item = this.$store.getters['modifier/findModifier'](
        item.entity_id,
        orderItem
      )
      if (found_item) {
        return this.translate_entity(found_item, 'name')
      } else {
        return ''
      }
    },
    translate_item_discount(item) {
      var found_item = this.$store.getters['discount/itemDiscounts'].find(
        loaded_item => loaded_item._id == item.entity_id
      )
      if (found_item) {
        return this.translate_entity(found_item, 'name')
      } else {
        return ''
      }
    },
    translate_surcharge(item) {
      var found_item = this.$store.state.surcharge.surcharges.find(
        loaded_item => loaded_item._id == item.entity_id
      )
      if (found_item) {
        return this.translate_entity(found_item, 'name')
      } else {
        return ''
      }
    },
    translate_order_discount(item) {
      var found_item = this.$store.getters['discount/orderDiscounts'].find(
        loaded_item => loaded_item._id == item.entity_id
      )
      if (found_item) {
        return this.translate_entity(found_item, 'name')
      } else {
        return ''
      }
    },
    translate_payment_type(item) {
      var found_item = this.$store.getters['payment/methods'].find(
        loaded_item => loaded_item._id == item.entity_id
      )
      if (found_item) {
        return this.translate_entity(found_item, 'name')
      } else {
        return ''
      }
    },
    get_delivery_area_name(delivery_area_id) {
      var found = this.$store.state.customer.fetchDeliveryAreas.find(
        item => item._id == delivery_area_id
      )
      if (found) {
        return found.text
      }
    },
    toDataURL(src, callback, outputFormat) {
      var img = new Image()
      img.crossOrigin = 'Anonymous'

      img.src = src
      if (img.complete || img.complete === undefined) {
        img.src =
          'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='
        img.src = src
      }

      img.onload = function() {
        var canvas = document.createElement('CANVAS')
        var ctx = canvas.getContext('2d')
        var dataURL
        canvas.height = this.naturalHeight
        canvas.width = this.naturalWidth
        ctx.drawImage(this, 0, 0)
        dataURL = canvas.toDataURL(outputFormat)
        callback(dataURL)
      }
    },
  },
}
</script>
